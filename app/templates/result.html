import pytesseract
import cv2
import fitz  # PyMuPDF
import os
import re
import requests
from dotenv import load_dotenv

load_dotenv()
API_TOKEN = os.getenv("VITE_SUREPASS_BEARER_TOKEN")

def extract_text_from_image(image_path):
    image = cv2.imread(image_path)
    if image is None:
        raise ValueError("Invalid image")
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
    return pytesseract.image_to_string(gray)

def extract_text_from_pdf(pdf_path):
    text = ""
    doc = fitz.open(pdf_path)
    for page in doc:
        text += page.get_text()
    return text

def extract_pan_number(text):
    match = re.search(r'[A-Z]{5}[0-9]{4}[A-Z]', text)
    return match.group(0) if match else None

def call_surepass_api(pan_number):
    url = "https://kyc-api.aadhaarkyc.io/api/v1/pan/pan"
    headers = {
        "Authorization": f"Bearer {API_TOKEN}",
        "Content-Type": "application/json"
    }
    payload = {"id_number": pan_number}

    try:
        response = requests.post(url, headers=headers, json=payload, timeout=10)
        data = response.json()
        if data.get("success") and data.get("data"):
            result = data["data"]
            return {
                "name": result.get("full_name", "").strip(),
                "dob": result.get("dob", "").strip(),
                "gender": result.get("gender", "").strip().lower(),
                "pan_number": pan_number
            }
        return {"error": data.get("message", "API verification failed"), "pan_number": pan_number}
    except Exception as e:
        return {"error": str(e), "pan_number": pan_number}

def extract_pan_data(file_path):
    ext = os.path.splitext(file_path)[1].lower()

    if ext in ['.png', '.jpg', '.jpeg']:
        text = extract_text_from_image(file_path)
    elif ext == '.pdf':
        text = extract_text_from_pdf(file_path)
    else:
        return {"error": "Unsupported file format"}

    pan_number = extract_pan_number(text)

    if not pan_number:
        return {"error": "PAN number not found in document"}

    return call_surepass_api(pan_number)
